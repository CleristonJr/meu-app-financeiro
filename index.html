<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* --- ESTILOS DIN√ÇMICOS --- */
        [data-bs-theme="dark"] {
            /* Seu Gradiente Personalizado */
            --bg-body: radial-gradient(#12045a , #050116 50%, #030109);
            --bg-card: #1e1e1e;
            --border-color: #333;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.7), 0 4px 10px rgba(0,0,0,0.5);
            --text-main: #e0e0e0;
            --input-bg: #2c2c2c;
            --chart-color: #bbb;
            --chart-grid: #444;
        }

        [data-bs-theme="light"] {
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --border-color: #dee2e6;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            --text-main: #212529;
            --input-bg: #fff;
            --chart-color: #666;
            --chart-grid: #ddd;
        }

        body { 
            background: var(--bg-body); 
            background-attachment: fixed;
            color: var(--text-main); 
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
        }

        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color); 
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .card-header-custom {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        /* Bot√£o Flutuante Tema */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--card-shadow);
            font-size: 1.5rem;
            transition: transform 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.1); }

        .form-control {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-main);
        }
        .form-control:focus {
            background-color: var(--input-bg);
            color: var(--text-main);
            border-color: #5c6bc0;
            box-shadow: 0 0 0 0.25rem rgba(92, 107, 192, 0.25);
        }
        
        .tabela-pagas { opacity: 0.8; }
        .riscado { text-decoration: line-through; color: #999 !important; opacity: 0.7; }
        .texto-data-pago { color: #198754; font-size: 0.85em; font-weight: bold; }
        .texto-positivo { color: #22c55e; font-weight: bold; }

        @media (max-width: 768px) {
            .btn-action { padding: 4px 10px; margin-bottom: 5px; }
            .theme-toggle { top: 10px; right: 10px; width: 40px; height: 40px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<button onclick="alternarTema()" class="btn btn-primary theme-toggle" id="btnTema" title="Mudar Tema">
    <i class="bi bi-moon-stars-fill"></i>
</button>

<div class="container py-4" style="max-width: 1000px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-white m-0">üí∞ Controle Financeiro</h4>
        <button class="btn btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalGanho">
            <i class="bi bi-plus-circle"></i> NOVO GANHO
        </button>
    </div>

    <div class="card p-3">
        <div class="card-header-custom text-center mb-2 fs-5">üìä Fluxo de Despesas (Dia a Dia)</div>
        <div style="height: 250px;">
            <canvas id="graficoDias"></canvas>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-3 h-100">
                <h5 class="mb-3 text-center text-primary fw-bold">‚ûï Nova Despesa</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label small text-muted fw-bold">Nome da Conta</label>
                        <input type="text" id="novoNome" class="form-control" placeholder="Ex: Internet">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted fw-bold">Vencimento</label>
                        <input type="number" id="novoDia" class="form-control" placeholder="10">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted fw-bold">Valor</label>
                        <input type="text" id="novoValor" class="form-control" placeholder="R$ 0,00">
                    </div>
                    <div class="col-12">
                         <label class="form-label small text-muted fw-bold">Observa√ß√£o</label>
                        <input type="text" id="novaObs" class="form-control" placeholder="Opcional">
                    </div>
                    <div class="col-12 mt-4">
                        <button onclick="adicionarDespesa()" class="btn btn-primary w-100 fw-bold shadow-sm">ADICIONAR DESPESA</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            
            <div class="card p-3 border-success border-opacity-50" style="border-width: 1px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-success fw-bold m-0">ü§ë Ganhos / Entradas</h5>
                    <span class="badge bg-success bg-opacity-25 text-success border border-success" id="totalGanhos">Total: R$ 0,00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Fonte</th>
                                <th>Valor</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaGanhos"></tbody>
                    </table>
                </div>
                <p id="msgVazioGanhos" class="text-center text-muted mt-3 small" style="display:none;">Nenhum ganho registrado.</p>
            </div>

            <div class="card p-3 border-danger border-opacity-50" style="border-width: 1px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-danger fw-bold m-0">üìÖ A Pagar (Pendentes)</h5>
                    <span class="badge bg-danger bg-opacity-25 text-danger border border-danger" id="totalPagar">Total: R$ 0,00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Conta</th>
                                <th>Valor</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPendentes"></tbody>
                    </table>
                </div>
                <p id="msgVazioPendentes" class="text-center text-muted mt-3 small" style="display:none;">Nenhuma conta pendente üéâ</p>
            </div>

            <div class="card p-3 tabela-pagas border-secondary" style="border-width: 1px;">
                <h5 class="text-secondary text-center mb-3 fw-bold">‚úÖ Hist√≥rico de Pagos</h5>
                 <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Conta</th>
                                <th>Valor</th>
                                <th>Pago em</th>
                                <th class="text-end">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPagas"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 my-4 pb-5">
        <button onclick="salvarNoGithub()" id="btnSalvar" class="btn btn-primary btn-lg fw-bold shadow">
            üíæ SALVAR ALTERA√á√ïES NO GITHUB
        </button>
    </div>

</div>

<div class="modal fade" id="modalGanho" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-success">
                <h5 class="modal-title fw-bold text-success">üí∞ Adicionar Novo Ganho</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="small text-muted fw-bold">Origem (Ex: Sal√°rio, Freelance)</label>
                    <input type="text" id="ganhoNome" class="form-control">
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Dia Recebimento</label>
                        <input type="number" id="ganhoDia" class="form-control" placeholder="05">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Valor</label>
                        <input type="text" id="ganhoValor" class="form-control" placeholder="R$ 0,00">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="small text-muted fw-bold">Obs</label>
                    <input type="text" id="ganhoObs" class="form-control">
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success fw-bold" onclick="adicionarGanho()">Salvar Ganho</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdicao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">‚úèÔ∏è Editar Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIndex"> 
                <div class="mb-3"><label class="small text-muted fw-bold">Nome</label><input type="text" id="editNome" class="form-control"></div>
                <div class="row mb-3">
                    <div class="col-6"><label class="small text-muted fw-bold">Dia</label><input type="number" id="editDia" class="form-control"></div>
                    <div class="col-6"><label class="small text-muted fw-bold">Valor</label><input type="text" id="editValor" class="form-control"></div>
                </div>
                <div class="mb-2"><label class="small text-muted fw-bold">Obs</label><input type="text" id="editObs" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary fw-bold" onclick="salvarEdicao()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ‚ö†Ô∏è CONFIGURA√á√ÉO ‚ö†Ô∏è ---
    const USUARIO = "CleristonJr";
    const REPOSITORIO = "ContasAPagar";
    const TOKEN = "ghp_SEU_TOKEN_AQUI"; // <--- SEU TOKEN
    // --------------------------

    const API_URL = `https://api.github.com/repos/${USUARIO}/${REPOSITORIO}/contents/contas.json`;
    let dadosAtuais = [];
    let shaArquivo = "";
    let modalEdicaoBS;
    let modalGanhoBS;
    let meuGrafico = null;

    function aplicarTemaInicial() {
        const temaSalvo = localStorage.getItem('tema') || 'dark';
        document.documentElement.setAttribute('data-bs-theme', temaSalvo);
        atualizarIconeTema(temaSalvo);
    }

    function alternarTema() {
        const html = document.documentElement;
        const novoTema = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-bs-theme', novoTema);
        localStorage.setItem('tema', novoTema);
        atualizarIconeTema(novoTema);
        if(meuGrafico) atualizarGrafico(); 
    }

    function atualizarIconeTema(tema) {
        const btn = document.getElementById('btnTema');
        if (tema === 'dark') {
            btn.innerHTML = '<i class="bi bi-moon-stars-fill"></i>';
            btn.className = 'btn btn-primary theme-toggle';
        } else {
            btn.innerHTML = '<i class="bi bi-sun-fill"></i>';
            btn.className = 'btn btn-warning theme-toggle text-dark';
        }
    }

    window.onload = function() {
        aplicarTemaInicial();
        modalEdicaoBS = new bootstrap.Modal(document.getElementById('modalEdicao'));
        modalGanhoBS = new bootstrap.Modal(document.getElementById('modalGanho'));
        carregarDados();
    };

    function textoParaFloat(texto) {
        let limpo = texto.replace('R$', '').replaceAll('.', '').replace(',', '.').trim();
        return parseFloat(limpo) || 0;
    }

    // --- GR√ÅFICO (FILTRADO S√ì PARA DESPESAS) ---
    function atualizarGrafico() {
        const temaAtual = document.documentElement.getAttribute('data-bs-theme');
        const corTexto = temaAtual === 'dark' ? '#bbb' : '#333';
        const corGrid = temaAtual === 'dark' ? '#444' : '#ddd';

        const resumoPorDia = {};
        
        // Filtra apenas despesas para o gr√°fico
        dadosAtuais.filter(d => d.tipo !== 'ganho').forEach(conta => {
            const dia = conta.dia;
            const valor = textoParaFloat(conta.valor);
            if (!resumoPorDia[dia]) resumoPorDia[dia] = { total: 0, pago: 0 };
            resumoPorDia[dia].total += valor;
            if (conta.pago) resumoPorDia[dia].pago += valor;
        });

        const dias = Object.keys(resumoPorDia).sort((a, b) => parseInt(a) - parseInt(b));
        const labels = dias.map(d => `Dia ${d}`);
        const vlrPagos = dias.map(d => resumoPorDia[d].pago.toFixed(2));
        const vlrResto = dias.map(d => (resumoPorDia[d].total - resumoPorDia[d].pago).toFixed(2));

        const ctx = document.getElementById('graficoDias').getContext('2d');
        if (meuGrafico) meuGrafico.destroy();

        Chart.defaults.color = corTexto;
        Chart.defaults.borderColor = corGrid;

        meuGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Pago', data: vlrPagos, backgroundColor: '#22c55e', stack: '0', borderRadius: 4 },
                    { label: 'Falta', data: vlrResto, backgroundColor: '#ef4444', stack: '0', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: corGrid } }
                }
            }
        });
    }

    async function carregarDados() {
        try {
            const urlTime = `${API_URL}?t=${new Date().getTime()}`;
            const resp = await fetch(urlTime, { headers: { 'Authorization': `token ${TOKEN}` } });
            const json = await resp.json();
            const conteudo = decodeURIComponent(escape(window.atob(json.content)));
            shaArquivo = json.sha;
            dadosAtuais = JSON.parse(conteudo);
            renderizarTudo();
        } catch (erro) {
            console.error(erro);
            alert("Erro ao carregar! Verifique o Token.");
        }
    }

    function renderizarTudo() {
        // Ordena tudo por dia
        dadosAtuais.sort((a, b) => a.dia - b.dia);
        renderizarTabelas();
        atualizarGrafico();
    }

    function renderizarTabelas() {
        const tGanhos = document.getElementById('tabelaGanhos');
        const tPendentes = document.getElementById('tabelaPendentes');
        const tPagas = document.getElementById('tabelaPagas');
        
        tGanhos.innerHTML = "";
        tPendentes.innerHTML = "";
        tPagas.innerHTML = "";
        
        let sumGanhos = 0;
        let sumPagar = 0;
        let countGanhos = 0;
        let countPendentes = 0;

        dadosAtuais.forEach((c, i) => {
            const val = textoParaFloat(c.valor);
            
            // SE FOR GANHO
            if (c.tipo === 'ganho') {
                countGanhos++;
                sumGanhos += val;
                tGanhos.innerHTML += `
                    <tr>
                        <td class="fw-bold">${c.dia}</td>
                        <td>${c.nome} <div class="small text-muted">${c.obs || ''}</div></td>
                        <td class="texto-positivo">${c.valor}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info btn-action" onclick="abrirEdicao(${i})"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="removerItem(${i})"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>`;
            } 
            // SE FOR DESPESA
            else {
                if (!c.pago) {
                    countPendentes++;
                    sumPagar += val;
                    tPendentes.innerHTML += `
                        <tr>
                            <td class="fw-bold text-white">${c.dia}</td>
                            <td>${c.nome} <div class="small text-muted">${c.obs || ''}</div></td>
                            <td class="text-warning fw-bold">${c.valor}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-info btn-action" onclick="abrirEdicao(${i})"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm btn-success btn-action" onclick="alternarStatus(${i})"><i class="bi bi-check-lg"></i></button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="removerItem(${i})"><i class="bi bi-trash-fill"></i></button>
                            </td>
                        </tr>`;
                } else {
                    tPagas.innerHTML += `
                        <tr class="riscado">
                            <td>${c.dia}</td>
                            <td>${c.nome}</td>
                            <td>${c.valor}</td>
                            <td class="texto-data-pago">${c.data_pagamento || '-'}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary btn-action" onclick="alternarStatus(${i})"><i class="bi bi-arrow-counterclockwise"></i></button>
                                <button class="btn btn-sm btn-outline-secondary btn-action" onclick="removerItem(${i})"><i class="bi bi-x-lg"></i></button>
                            </td>
                        </tr>`;
                }
            }
        });

        // Atualiza Badges de Totais
        document.getElementById('totalGanhos').innerText = `Total: R$ ${sumGanhos.toFixed(2).replace('.',',')}`;
        document.getElementById('totalPagar').innerText = `Total: R$ ${sumPagar.toFixed(2).replace('.',',')}`;

        // Mostra msg se vazio
        document.getElementById('msgVazioGanhos').style.display = countGanhos ? 'none' : 'block';
        document.getElementById('msgVazioPendentes').style.display = countPendentes ? 'none' : 'block';
    }

    // --- FUN√á√ïES DE ADICIONAR ---

    function formatarDinheiro(val) {
        val = val.replace('R$', '').trim();
        return "R$ " + val;
    }

    function adicionarDespesa() {
        const nome = document.getElementById('novoNome').value;
        const dia = parseInt(document.getElementById('novoDia').value);
        let valor = document.getElementById('novoValor').value;
        const obs = document.getElementById('novaObs').value;

        if (!nome || !dia || !valor) return alert("Preencha os campos!");
        
        dadosAtuais.push({ nome, dia, valor: formatarDinheiro(valor), obs, pago: false, tipo: 'despesa' });
        renderizarTudo();
        
        document.getElementById('novoNome').value = "";
        document.getElementById('novoValor').value = "";
        document.getElementById('novaObs').value = "";
    }

    function adicionarGanho() {
        const nome = document.getElementById('ganhoNome').value;
        const dia = parseInt(document.getElementById('ganhoDia').value);
        let valor = document.getElementById('ganhoValor').value;
        const obs = document.getElementById('ganhoObs').value;

        if (!nome || !dia || !valor) return alert("Preencha os campos do ganho!");

        // Aqui adicionamos o tipo: 'ganho'
        dadosAtuais.push({ nome, dia, valor: formatarDinheiro(valor), obs, tipo: 'ganho' });
        renderizarTudo();

        document.getElementById('ganhoNome').value = "";
        document.getElementById('ganhoValor').value = "";
        document.getElementById('ganhoObs').value = "";
        modalGanhoBS.hide();
    }

    function removerItem(i) {
        if(confirm("Tem certeza que deseja apagar?")) {
            dadosAtuais.splice(i, 1);
            renderizarTudo();
        }
    }

    function alternarStatus(i) {
        dadosAtuais[i].pago = !dadosAtuais[i].pago;
        if (dadosAtuais[i].pago) dadosAtuais[i].data_pagamento = new Date().toLocaleDateString('pt-BR');
        else delete dadosAtuais[i].data_pagamento;
        renderizarTudo();
    }

    function abrirEdicao(i) {
        const c = dadosAtuais[i];
        document.getElementById('editIndex').value = i;
        document.getElementById('editNome').value = c.nome;
        document.getElementById('editDia').value = c.dia;
        document.getElementById('editValor').value = c.valor;
        document.getElementById('editObs').value = c.obs;
        modalEdicaoBS.show();
    }

    function salvarEdicao() {
        const i = document.getElementById('editIndex').value;
        let val = document.getElementById('editValor').value;

        dadosAtuais[i].nome = document.getElementById('editNome').value;
        dadosAtuais[i].dia = parseInt(document.getElementById('editDia').value);
        dadosAtuais[i].valor = formatarDinheiro(val);
        dadosAtuais[i].obs = document.getElementById('editObs').value;
        modalEdicaoBS.hide();
        renderizarTudo();
    }

    async function salvarNoGithub() {
        const btn = document.getElementById('btnSalvar');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Salvando...';

        try {
            const jsonStr = JSON.stringify(dadosAtuais, null, 2);
            const contentBase64 = window.btoa(unescape(encodeURIComponent(jsonStr)));
            const body = { message: "Update via Panel (Com Ganhos)", content: contentBase64, sha: shaArquivo };

            const resp = await fetch(API_URL, {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (resp.ok) {
                alert("‚úÖ Sucesso!");
                location.reload();
            } else { throw new Error("Erro GitHub"); }
        } catch (e) {
            console.error(e);
            alert("‚ùå Erro ao salvar!");
            btn.disabled = false;
            btn.innerText = "üíæ TENTAR NOVAMENTE";
        }
    }
</script>
</body>
</html>
