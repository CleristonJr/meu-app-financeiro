<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Cyberpunk Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* --- ESTILO VISUAL CYBERPUNK --- */
        [data-bs-theme="dark"] {
            --bg-body: radial-gradient(#12045a , #050116 50%, #030109);
            --bg-card: #1e1e1e;
            --border-color: #333;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 4px 10px rgba(0,0,0,0.6);
            --text-main: #e0e0e0;
            --input-bg: #2c2c2c;
            --chart-color: #bbb;
            --chart-grid: #444;
        }

        [data-bs-theme="light"] {
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --border-color: #dee2e6;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
            --text-main: #212529;
            --input-bg: #fff;
            --chart-color: #666;
            --chart-grid: #ddd;
        }

        body { 
            background: var(--bg-body); 
            background-attachment: fixed;
            color: var(--text-main); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* LOGIN */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }

        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color); 
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border-radius: 12px;
        }

        .form-control {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-main);
        }
        .form-control:focus {
            background-color: var(--input-bg);
            color: var(--text-main);
            border-color: #6610f2;
            box-shadow: 0 0 0 0.25rem rgba(102, 16, 242, 0.25);
        }

        .theme-toggle {
            position: fixed; top: 20px; right: 20px; z-index: 1050;
            border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--card-shadow); font-size: 1.5rem;
            transition: transform 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        
        .btn-logout {
            position: fixed; top: 80px; right: 20px; z-index: 1050;
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--card-shadow); font-size: 1.2rem;
        }

        /* Custom Colors */
        .riscado { text-decoration: line-through; color: #777 !important; }
        .texto-positivo { color: #00ff88; font-weight: bold; }
        .texto-negativo { color: #ff4d4d; font-weight: bold; }
        
        /* Saldo Display */
        .saldo-box {
            font-size: 1.5rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .saldo-verde { color: #00ff88; }
        .saldo-vermelho { color: #ff4d4d; }

        @media (max-width: 768px) {
            .btn-action { padding: 4px 8px; }
            .theme-toggle { top: 10px; right: 10px; width: 40px; height: 40px; }
            .btn-logout { top: 60px; right: 10px; width: 35px; height: 35px; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="card p-5 text-center" style="max-width: 400px; width: 90%;">
        <h2 class="mb-4 fw-bold">üîí Acesso Seguro</h2>
        <p class="text-muted small mb-3">Insira seu Token do GitHub</p>
        <div class="mb-3">
            <input type="password" id="inputToken" class="form-control form-control-lg text-center" placeholder="ghp_...">
        </div>
        <button onclick="fazerLogin()" class="btn btn-primary btn-lg w-100 fw-bold shadow">ENTRAR</button>
    </div>
</div>

<button onclick="alternarTema()" class="btn btn-primary theme-toggle" id="btnTema"><i class="bi bi-moon-stars-fill"></i></button>
<button onclick="fazerLogout()" class="btn btn-danger btn-logout"><i class="bi bi-box-arrow-right"></i></button>

<div class="container py-4" id="painelPrincipal" style="max-width: 1100px; display: none;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-white m-0"><i class="bi bi-wallet2"></i> Controle Financeiro</h4>
        <button class="btn btn-success fw-bold shadow" data-bs-toggle="modal" data-bs-target="#modalGanho">
            <i class="bi bi-plus-lg"></i> GANHO
        </button>
    </div>

    <div class="card p-3 border-0">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="text-center text-md-start mb-2 fs-5 fw-bold text-secondary">üìä Fluxo de Despesas</div>
                <div style="height: 200px;">
                    <canvas id="graficoDias"></canvas>
                </div>
            </div>
            <div class="col-md-4 text-center border-start border-secondary border-opacity-25 mt-3 mt-md-0">
                <h6 class="text-muted text-uppercase fw-bold ls-1">Saldo Final</h6>
                <div class="small text-muted mb-2">(Entradas - Total Despesas)</div>
                <div id="displaySaldo" class="saldo-box">Carregando...</div>
                <div id="msgSaldo" class="small mt-2 fw-bold"></div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-3 h-100 border-primary border-opacity-25" style="border-width: 2px;">
                <h5 class="mb-3 text-center text-primary fw-bold">‚ûï Nova Despesa</h5>
                <div class="row g-2">
                    <div class="col-12"><label class="small text-muted">Nome</label><input type="text" id="novoNome" class="form-control"></div>
                    <div class="col-6"><label class="small text-muted">Dia</label><input type="number" id="novoDia" class="form-control" placeholder="10"></div>
                    <div class="col-6"><label class="small text-muted">Valor</label><input type="text" id="novoValor" class="form-control" placeholder="0,00"></div>
                    <div class="col-12"><label class="small text-muted">Obs</label><input type="text" id="novaObs" class="form-control"></div>
                    
                    <div class="col-12 mt-2">
                        <div class="form-check form-switch p-2 border rounded bg-opacity-10 bg-secondary">
                            <input class="form-check-input" type="checkbox" id="novoPago" style="margin-left: 0.5em; cursor: pointer;">
                            <label class="form-check-label fw-bold ms-2" for="novoPago">Essa conta j√° est√° paga?</label>
                        </div>
                    </div>

                    <div class="col-12 mt-3"><button onclick="adicionarDespesa()" class="btn btn-primary w-100 fw-bold shadow">Lan√ßar</button></div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card p-3 border-success border-opacity-25" style="border-width: 1px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-success fw-bold m-0"><i class="bi bi-graph-up-arrow"></i> Entradas</h5>
                    <span class="badge bg-success bg-opacity-10 text-success border border-success" id="totalGanhos">R$ 0,00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm mb-0">
                        <tbody id="tabelaGanhos"></tbody>
                    </table>
                </div>
                <p id="msgVazioGanhos" class="text-center text-muted mt-2 small" style="display:none;">Sem registros.</p>
            </div>

            <div class="card p-3 border-danger border-opacity-25" style="border-width: 1px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-danger fw-bold m-0"><i class="bi bi-hourglass-split"></i> A Pagar</h5>
                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger" id="totalPagar">R$ 0,00</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm mb-0">
                        <tbody id="tabelaPendentes"></tbody>
                    </table>
                </div>
                <p id="msgVazioPendentes" class="text-center text-muted mt-2 small" style="display:none;">Tudo pago! üéâ</p>
            </div>

            <div class="card p-3 opacity-75">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-secondary fw-bold m-0"><i class="bi bi-check2-circle"></i> Hist√≥rico</h5>
                    <span class="badge bg-secondary bg-opacity-25 text-light border border-secondary" id="totalHistorico">R$ 0,00</span>
                </div>
                 <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <tbody id="tabelaPagas"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 my-4 pb-5">
        <button onclick="salvarNoGithub()" id="btnSalvar" class="btn btn-success btn-lg fw-bold shadow">üíæ SALVAR TUDO NO GITHUB</button>
    </div>
</div>

<div class="modal fade" id="modalGanho" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold text-success">üí∞ Entrada de Valor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-2"><label class="small text-muted">Origem</label><input type="text" id="ganhoNome" class="form-control"></div>
                <div class="row mb-2">
                    <div class="col-6"><label class="small text-muted">Dia</label><input type="number" id="ganhoDia" class="form-control"></div>
                    <div class="col-6"><label class="small text-muted">Valor</label><input type="text" id="ganhoValor" class="form-control"></div>
                </div>
                <div class="mb-2"><label class="small text-muted">Obs</label><input type="text" id="ganhoObs" class="form-control"></div>
            </div>
            <div class="modal-footer border-0"><button onclick="adicionarGanho()" class="btn btn-success w-100 fw-bold">Confirmar</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdicao" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">‚úèÔ∏è Editar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editIndex"> 
                <div class="mb-2"><label class="small text-muted">Nome</label><input type="text" id="editNome" class="form-control"></div>
                <div class="row mb-2">
                    <div class="col-6"><label class="small text-muted">Dia</label><input type="number" id="editDia" class="form-control"></div>
                    <div class="col-6"><label class="small text-muted">Valor</label><input type="text" id="editValor" class="form-control"></div>
                </div>
                <div class="mb-2"><label class="small text-muted">Obs</label><input type="text" id="editObs" class="form-control"></div>
            </div>
            <div class="modal-footer border-0"><button onclick="salvarEdicao()" class="btn btn-primary w-100 fw-bold">Salvar Altera√ß√µes</button></div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ÉO ---
    const USUARIO = "CleristonJr";
    const REPOSITORIO = "ContasAPagar";
    // --------------------

    let TOKEN = localStorage.getItem('github_token') || "";
    const API_URL = `https://api.github.com/repos/${USUARIO}/${REPOSITORIO}/contents/contas.json`;
    let dadosAtuais = [];
    let shaArquivo = "";
    let modalEdicaoBS, modalGanhoBS, meuGrafico;

    // --- LOGIN ---
    function verificarLogin() {
        if(TOKEN && TOKEN.startsWith('ghp_')) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('painelPrincipal').style.display = 'block';
            carregarDados();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('painelPrincipal').style.display = 'none';
        }
    }

    function fazerLogin() {
        const input = document.getElementById('inputToken').value.trim();
        if(!input.startsWith('ghp_')) return alert("Token inv√°lido! Deve come√ßar com 'ghp_'");
        localStorage.setItem('github_token', input);
        TOKEN = input;
        verificarLogin();
    }

    function fazerLogout() {
        if(confirm("Sair?")) { localStorage.removeItem('github_token'); location.reload(); }
    }

    window.onload = function() {
        const tema = localStorage.getItem('tema') || 'dark';
        document.documentElement.setAttribute('data-bs-theme', tema);
        modalEdicaoBS = new bootstrap.Modal(document.getElementById('modalEdicao'));
        modalGanhoBS = new bootstrap.Modal(document.getElementById('modalGanho'));
        verificarLogin();
    };

    function alternarTema() {
        const html = document.documentElement;
        const novo = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-bs-theme', novo);
        localStorage.setItem('tema', novo);
        if(meuGrafico) atualizarGrafico();
    }

    // --- DADOS ---
    function fmtDinheiro(v) { return "R$ " + v.replace('R$', '').trim(); }
    function strToFloat(v) { return parseFloat(v.replace('R$','').replaceAll('.','').replace(',','.')) || 0; }

    async function carregarDados() {
        try {
            const resp = await fetch(`${API_URL}?t=${Date.now()}`, { headers: { 'Authorization': `token ${TOKEN}` } });
            if(resp.status === 401) { alert("Token inv√°lido!"); fazerLogout(); return; }
            const json = await resp.json();
            dadosAtuais = JSON.parse(decodeURIComponent(escape(atob(json.content))));
            shaArquivo = json.sha;
            renderizarTudo();
        } catch (e) { console.error(e); alert("Erro ao carregar dados."); }
    }

    function renderizarTudo() {
        dadosAtuais.sort((a, b) => a.dia - b.dia);
        
        const tGanhos = document.getElementById('tabelaGanhos');
        const tPendentes = document.getElementById('tabelaPendentes');
        const tPagas = document.getElementById('tabelaPagas');
        
        tGanhos.innerHTML = ""; tPendentes.innerHTML = ""; tPagas.innerHTML = "";
        
        let sGanhos = 0, sPagar = 0, sHistorico = 0; // Soma dos valores
        let cGanhos = 0, cPend = 0;

        dadosAtuais.forEach((c, i) => {
            const val = strToFloat(c.valor);
            
            if(c.tipo === 'ganho') {
                sGanhos += val; cGanhos++;
                tGanhos.innerHTML += `
                    <tr>
                        <td class="fw-bold">${c.dia}</td>
                        <td>${c.nome}</td>
                        <td class="texto-positivo">${c.valor}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info btn-action" onclick="abrirEdicao(${i})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="removerItem(${i})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            } else {
                // √â Despesa
                if(!c.pago) {
                    sPagar += val; cPend++;
                    tPendentes.innerHTML += `
                        <tr>
                            <td class="fw-bold fs-5 text-white">${c.dia}</td>
                            <td>${c.nome} <br><small class="text-muted">${c.obs||''}</small></td>
                            <td class="texto-negativo">${c.valor}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-info btn-action" onclick="abrirEdicao(${i})"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm btn-success btn-action" onclick="alternarStatus(${i})"><i class="bi bi-check-lg"></i></button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="removerItem(${i})"><i class="bi bi-trash-fill"></i></button>
                            </td>
                        </tr>`;
                } else {
                    sHistorico += val;
                    tPagas.innerHTML += `
                        <tr class="riscado">
                            <td>${c.dia}</td><td>${c.nome}</td><td>${c.valor}</td>
                            <td class="text-end"><button class="btn btn-sm btn-outline-secondary btn-action" onclick="alternarStatus(${i})"><i class="bi bi-arrow-counterclockwise"></i></button></td>
                        </tr>`;
                }
            }
        });

        // Atualiza Badges e Totais
        document.getElementById('totalGanhos').innerText = "R$ " + sGanhos.toFixed(2).replace('.',',');
        document.getElementById('totalPagar').innerText = "R$ " + sPagar.toFixed(2).replace('.',',');
        document.getElementById('totalHistorico').innerText = "R$ " + sHistorico.toFixed(2).replace('.',',');
        
        // --- C√ÅLCULO DO SALDO (Entradas - Total Despesas) ---
        const totalDespesas = sPagar + sHistorico;
        const saldo = sGanhos - totalDespesas;
        const divSaldo = document.getElementById('displaySaldo');
        const msgSaldo = document.getElementById('msgSaldo');
        
        divSaldo.innerText = "R$ " + saldo.toFixed(2).replace('.',',');
        
        if(saldo >= 0) {
            divSaldo.className = "saldo-box saldo-verde";
            msgSaldo.innerText = "Parab√©ns! Voc√™ est√° no azul. ü§ë";
            msgSaldo.className = "small mt-2 fw-bold text-success";
        } else {
            divSaldo.className = "saldo-box saldo-vermelho";
            msgSaldo.innerText = "Aten√ß√£o! Voc√™ est√° gastando mais do que ganha. üö®";
            msgSaldo.className = "small mt-2 fw-bold text-danger";
        }

        document.getElementById('msgVazioGanhos').style.display = cGanhos ? 'none' : 'block';
        document.getElementById('msgVazioPendentes').style.display = cPend ? 'none' : 'block';
        
        atualizarGrafico();
    }

    function atualizarGrafico() {
        const dark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const corTxt = dark ? '#bbb' : '#333';
        
        const resumo = {};
        dadosAtuais.filter(d => d.tipo !== 'ganho').forEach(d => {
            const val = strToFloat(d.valor);
            if(!resumo[d.dia]) resumo[d.dia] = { total: 0, pago: 0 };
            resumo[d.dia].total += val;
            if(d.pago) resumo[d.dia].pago += val;
        });

        const dias = Object.keys(resumo).sort((a,b)=>a-b);
        const ctx = document.getElementById('graficoDias').getContext('2d');
        if(meuGrafico) meuGrafico.destroy();
        
        Chart.defaults.color = corTxt;
        Chart.defaults.borderColor = dark ? '#444' : '#ddd';

        meuGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dias.map(d => `Dia ${d}`),
                datasets: [
                    { label: 'Pago', data: dias.map(d=>resumo[d].pago), backgroundColor: '#198754', stack:'0' },
                    { label: 'Falta', data: dias.map(d=>resumo[d].total-resumo[d].pago), backgroundColor: '#dc3545', stack:'0' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y:{beginAtZero:true} } }
        });
    }

    // --- A√á√ïES ---
    function adicionarDespesa() {
        const n = document.getElementById('novoNome').value, d = document.getElementById('novoDia').value, v = document.getElementById('novoValor').value, o = document.getElementById('novaObs').value;
        // Verifica o Switch "J√° Pago?"
        const jaPago = document.getElementById('novoPago').checked;
        
        if(!n || !d || !v) return alert("Preencha tudo!");
        
        const novaConta = { 
            nome:n, 
            dia:parseInt(d), 
            valor:fmtDinheiro(v), 
            obs:o, 
            pago: jaPago, // Define se j√° nasce pago
            tipo:'despesa' 
        };
        
        // Se j√° pago, adiciona a data de hoje
        if(jaPago) novaConta.data_pagamento = new Date().toLocaleDateString('pt-BR');

        dadosAtuais.push(novaConta);
        renderizarTudo(); limpaForm('novo');
        // Reseta o switch
        document.getElementById('novoPago').checked = false;
    }

    function adicionarGanho() {
        const n = document.getElementById('ganhoNome').value, d = document.getElementById('ganhoDia').value, v = document.getElementById('ganhoValor').value, o = document.getElementById('ganhoObs').value;
        if(!n || !d || !v) return alert("Preencha tudo!");
        dadosAtuais.push({ nome:n, dia:parseInt(d), valor:fmtDinheiro(v), obs:o, tipo:'ganho' });
        renderizarTudo(); limpaForm('ganho'); modalGanhoBS.hide();
    }

    function limpaForm(p) { document.getElementById(p+'Nome').value=""; document.getElementById(p+'Valor').value=""; document.getElementById(p+'Obs').value=""; }
    function removerItem(i) { if(confirm("Apagar?")) { dadosAtuais.splice(i,1); renderizarTudo(); } }
    
    function alternarStatus(i) {
        dadosAtuais[i].pago = !dadosAtuais[i].pago;
        dadosAtuais[i].data_pagamento = dadosAtuais[i].pago ? new Date().toLocaleDateString('pt-BR') : undefined;
        renderizarTudo();
    }

    function abrirEdicao(i) {
        const c = dadosAtuais[i];
        document.getElementById('editIndex').value=i; document.getElementById('editNome').value=c.nome;
        document.getElementById('editDia').value=c.dia; document.getElementById('editValor').value=c.valor;
        document.getElementById('editObs').value=c.obs||''; modalEdicaoBS.show();
    }

    function salvarEdicao() {
        const i = document.getElementById('editIndex').value;
        dadosAtuais[i].nome = document.getElementById('editNome').value;
        dadosAtuais[i].dia = parseInt(document.getElementById('editDia').value);
        dadosAtuais[i].valor = fmtDinheiro(document.getElementById('editValor').value);
        dadosAtuais[i].obs = document.getElementById('editObs').value;
        modalEdicaoBS.hide(); renderizarTudo();
    }

    async function salvarNoGithub() {
        const btn = document.getElementById('btnSalvar'); btn.disabled=true; btn.innerText="Salvando...";
        try {
            const body = { message: "Update via App", content: btoa(unescape(encodeURIComponent(JSON.stringify(dadosAtuais,null,2)))), sha: shaArquivo };
            const r = await fetch(API_URL, { method:'PUT', headers:{'Authorization':`token ${TOKEN}`, 'Content-Type':'application/json'}, body:JSON.stringify(body) });
            if(r.ok) { alert("‚úÖ Sucesso!"); location.reload(); } else throw new Error();
        } catch { alert("Erro ao salvar! Verifique conex√£o/token."); btn.disabled=false; btn.innerText="üíæ TENTAR NOVAMENTE"; }
    }
</script>
</body>
</html>
